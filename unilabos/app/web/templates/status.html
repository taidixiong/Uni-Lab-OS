{% extends "base.html" %}

{% block title %}UniLab System Status{% endblock %}

{% block header %}UniLab System Status{% endblock %}

{% block top_info %}
<!-- ç³»ç»Ÿæ¨¡å¼æ˜¾ç¤º -->
<div class="system-mode-banner">
    <div class="mode-indicator {% if is_host_mode %}host-mode{% else %}slave-mode{% endif %}">
        ç³»ç»Ÿæ¨¡å¼: <strong>{{ "ä¸»æœºæ¨¡å¼ (HOST)" if is_host_mode else "ä»æœºæ¨¡å¼ (SLAVE)" }}</strong>
    </div>
</div>

{% if registry_info %}
<div class="registry-info">
    {% if registry_info.paths %}
    <div class="registry-path">
        <strong>æ³¨å†Œè¡¨è·¯å¾„:</strong>
        <ul class="path-list">
        {% for path in registry_info.paths %}
            <li>
                <span class="path">{{ path }}</span>
                <span class="folder-link" onclick="openFolder('{{ path }}')" title="æ‰“å¼€æ–‡ä»¶å¤¹">ğŸ“</span>
            </li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    {% if registry_info.devices_paths %}
    <div class="registry-path">
        <strong>è®¾å¤‡ç›®å½•:</strong>
        <ul class="path-list">
        {% for path in registry_info.devices_paths %}
            <li>
                <span class="path">{{ path }}</span>
                <span class="folder-link" onclick="openFolder('{{ path }}')" title="æ‰“å¼€æ–‡ä»¶å¤¹">ğŸ“</span>
            </li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    {% if registry_info.device_comms_paths %}
    <div class="registry-path">
        <strong>è®¾å¤‡é€šä¿¡ç›®å½•:</strong>
        <ul class="path-list">
        {% for path in registry_info.device_comms_paths %}
            <li>
                <span class="path">{{ path }}</span>
                <span class="folder-link" onclick="openFolder('{{ path }}')" title="æ‰“å¼€æ–‡ä»¶å¤¹">ğŸ“</span>
            </li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    {% if registry_info.resources_paths %}
    <div class="registry-path">
        <strong>èµ„æºç›®å½•:</strong>
        <ul class="path-list">
        {% for path in registry_info.resources_paths %}
            <li>
                <span class="path">{{ path }}</span>
                <span class="folder-link" onclick="openFolder('{{ path }}')" title="æ‰“å¼€æ–‡ä»¶å¤¹">ğŸ“</span>
            </li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>
{% endif %}

<div class="nav-tabs">
    {% if is_host_mode and host_node_info.available %}
    <a href="#host-node-section" class="nav-tab">ä¸»æœºèŠ‚ç‚¹</a>
    {% endif %}
    <a href="#online-devices-section" class="nav-tab">æœ¬åœ°è®¾å¤‡</a>
    <a href="#devices-section" class="nav-tab">è®¾å¤‡ç±»å‹</a>
    <a href="#resources-section" class="nav-tab">èµ„æºç±»å‹</a>
    <a href="#modules-section" class="nav-tab">è½¬æ¢å™¨æ¨¡å—</a>
</div>
{% endblock %}

{% block content %}
<!-- ä¸»æœºèŠ‚ç‚¹ä¿¡æ¯éƒ¨åˆ† -->
{% if is_host_mode and host_node_info.available %}
<div class="card" id="host-node-section">
    <h2>ä¸»æœºèŠ‚ç‚¹ä¿¡æ¯</h2>
    
    <!-- ä¸»æœºæ§åˆ¶çš„è®¾å¤‡ -->
    <div class="host-section">
        <h3>å·²ç®¡ç†è®¾å¤‡ <span class="count-badge">{{ host_node_info.devices|length }}</span></h3>
        <table class="responsive-table">
            <tr>
                <th>è®¾å¤‡ID</th>
                <th>å‘½åç©ºé—´</th>
                <th>çŠ¶æ€</th>
            </tr>
            {% for device_id, device_info in host_node_info.devices.items() %}
            <tr>
                <td>{{ device_id }}</td>
                <td>{{ device_info.namespace }}</td>
                <td><span class="status-badge online">{{ "åœ¨çº¿" if device_info.is_online else "ç¦»çº¿" }}</span></td>
            </tr>
            {% else %}
            <tr>
                <td colspan="3" class="empty-state">æ²¡æœ‰å‘ç°å·²ç®¡ç†çš„è®¾å¤‡</td>
            </tr>
            {% endfor %}
        </table>
    </div>
    
    <!-- ä¸»æœºçš„åŠ¨ä½œå®¢æˆ·ç«¯ -->
    <div class="host-section">
        <h3>åŠ¨ä½œå®¢æˆ·ç«¯ <span class="count-badge">{{ host_node_info.action_clients|length }}</span></h3>
        <table class="responsive-table collapsible-table">
            <h4>å·²æ¥çº³åŠ¨ä½œ:</h4>
            <table class="inner-table">
                <tr>
                    <th>è¯é¢˜</th>
                    <th>ç±»å‹</th>
                    <th></th>
                </tr>
                {% for action_name, action_info in host_node_info.action_clients.items() %}
                <tr class="action-row collapsible-sub-row" data-target="action-cmd-{{ loop.index }}-{{ device_loop_index }}">
                    <td>{{ action_name }}</td>
                    <td>{{ action_info.type_name }}</td>
                    <td><span class="toggle-sub-indicator">â–¼</span></td>
                </tr>
                <tr id="action-cmd-{{ loop.index }}-{{ device_loop_index }}" class="cmd-row" style="display: none;">
                    <td colspan="5">
                        <div class="cmd-block">
                            <strong>å‘é€å‘½ä»¤:</strong>
                            <div class="cmd-line">
                                <pre>ros2 action send_goal {{ action_info.action_path }} {{ action_info.type_name_convert }} "{{ action_info.goal_info }}"</pre>
                                <button class="copy-btn" onclick="copyToClipboard(this.previousElementSibling.textContent, event)">å¤åˆ¶</button>
                            </div>
                            
                            <p class="goal-tip">æç¤º: æ ¹æ®ç›®æ ‡ç»“æ„ä¿®æ”¹å‘½ä»¤å‚æ•°</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </table>
        </table>
    </div>
    
    <!-- ä¸»æœºå·²è®¢é˜…çš„ä¸»é¢˜ -->
    <div class="host-section">
        <h3>å·²è®¢é˜…ä¸»é¢˜ <span class="count-badge">{{ host_node_info.subscribed_topics|length }}</span></h3>
        <div class="topics-container">
            {% if host_node_info.subscribed_topics %}
            <div class="topics-list">
                {% for topic in host_node_info.subscribed_topics %}
                <div class="topic-item">
                    <span class="topic-name">{{ topic }}</span>
                    <button class="copy-btn small" onclick="copyToClipboard('{{ topic }}', event)" title="å¤åˆ¶ä¸»é¢˜å">å¤åˆ¶</button>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">æ²¡æœ‰å‘ç°å·²è®¢é˜…çš„ä¸»é¢˜</div>
            {% endif %}
        </div>
    </div>
    
    <!-- è®¾å¤‡çŠ¶æ€ -->
    {% if host_node_info.device_status %}
    <div class="host-section">
        <h3>è®¾å¤‡çŠ¶æ€</h3>
        <table class="responsive-table">
            <tr>
                <th>è®¾å¤‡ID</th>
                <th>å±æ€§</th>
                <th>å€¼</th>
                <th>æœ€åæ›´æ–°</th>
            </tr>
            {% for device_id, properties in host_node_info.device_status.items() %}
                {% for prop_name, prop_value in properties.items() %}
                <tr>
                    {% if loop.first %}
                    <td rowspan="{{ properties|length }}">{{ device_id }}</td>
                    {% endif %}
                    <td>{{ prop_name }}</td>
                    <td>{{ prop_value }}</td>
                    <td>
                        {% if device_id in host_node_info.device_status_timestamps and prop_name in host_node_info.device_status_timestamps[device_id] %}
                            {% set ts_info = host_node_info.device_status_timestamps[device_id][prop_name] %}
                            {% if ts_info.elapsed >= 0 %}
                                <span class="timestamp" title="{{ ts_info.timestamp }}">{{ ts_info.elapsed }} ç§’å‰</span>
                            {% else %}
                                <span class="timestamp not-updated">æœªæ›´æ–°</span>
                            {% endif %}
                        {% else %}
                            <span class="timestamp not-updated">æ— æ•°æ®</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            {% else %}
            <tr>
                <td colspan="4" class="empty-state">æ²¡æœ‰è®¾å¤‡çŠ¶æ€æ•°æ®</td>
            </tr>
            {% endfor %}
        </table>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- å½“å‰ä¸­æ–­è®¾å¤‡éƒ¨åˆ† -->
<div class="card" id="online-devices-section">
    <h2>Local Devices</h2>
    <table class="responsive-table">
        <tr>
            <th>Device ID</th>
            <th>èŠ‚ç‚¹åç§°</th>
            <th>å‘½åç©ºé—´</th>
            <th>çŠ¶æ€é¡¹</th>
            <th>åŠ¨ä½œæ•°</th>
        </tr>
        {% for device_id, device_info in ros_node_info.registered_devices.items() %}
        {% set device_loop_index = loop.index %}
        <tr class="collapsible-row device-row" data-target="device-detail-{{ loop.index }}">
            <td>{{ device_id }}</td>
            <td>{{ device_info.node_name }}</td>
            <td>{{ device_info.namespace }}</td>
            <td>{{ ros_node_info.device_topics.get(device_id, {})|length }}</td>
            <td>{{ ros_node_info.device_actions.get(device_id, {})|length }} <span class="toggle-indicator">â–¼</span></td>
        </tr>
        <tr id="device-detail-{{ loop.index }}" class="detail-row" style="display: none;">
            <td colspan="5">
                <div class="content-full">
                    UUID: {{ device_info.uuid }}
                    {% if device_id in ros_node_info.device_topics %}
                    <h4>å·²å‘å¸ƒçŠ¶æ€:</h4>
                    <table class="inner-table">
                        <tr>
                            <th>åç§°</th>
                            <th>ç±»å‹</th>
                            <th>è¯é¢˜</th>
                            <th>é—´éš”</th>
                            <th></th>
                        </tr>
                        {% for status_name, status_info in ros_node_info.device_topics[device_id].items() %}
                        <tr class="topic-row collapsible-sub-row" data-target="topic-cmd-{{ loop.index }}-{{ device_loop_index }}">
                            <td>{{ status_name }}</td>
                            <td>{{ status_info.type_name }}</td>
                            <td>{{ status_info.topic_path }}</td>
                            <td>{{ status_info.timer_period }}</td>
                            <td><span class="toggle-sub-indicator">â–¼</span></td>
                        </tr>
                        <tr id="topic-cmd-{{ loop.index }}-{{ device_loop_index }}" class="cmd-row" style="display: none;">
                            <td colspan="5">
                                <div class="cmd-block">
                                    <strong>è®¢é˜…å‘½ä»¤:</strong>
                                    <div class="cmd-line">
                                        <pre>ros2 topic echo {{ status_info.topic_path }}</pre>
                                        <button class="copy-btn" onclick="copyToClipboard(this.previousElementSibling.textContent, event)">å¤åˆ¶</button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </table>
                    {% endif %}
                    
                    {% if device_id in ros_node_info.device_actions %}
                    <h4>å·²å‘å¸ƒåŠ¨ä½œ:</h4>
                    <table class="inner-table">
                        <tr>
                            <th>åç§°</th>
                            <th>ç±»å‹</th>
                            <th>è¯é¢˜</th>
                            <th></th>
                        </tr>
                        {% for action_name, action_info in ros_node_info.device_actions[device_id].items() %}
                        <tr class="action-row collapsible-sub-row" data-target="action-cmd-{{ loop.index }}-{{ device_loop_index }}">
                            <td>{{ action_name }}</td>
                            <td>{{ action_info.type_name }}</td>
                            <td>{{ action_info.action_path }}</td>
                            <td><span class="toggle-sub-indicator">â–¼</span></td>
                        </tr>
                        <tr id="action-cmd-{{ loop.index }}-{{ device_loop_index }}" class="cmd-row" style="display: none;">
                            <td colspan="5">
                                <div class="cmd-block">
                                    <strong>å‘é€å‘½ä»¤:</strong>
                                    <div class="cmd-line">
                                        <pre>ros2 action send_goal {{ action_info.action_path }} {{ action_info.type_name_convert }} "{{ action_info.goal_info }}"</pre>
                                        <button class="copy-btn" onclick="copyToClipboard(this.previousElementSibling.textContent, event)">å¤åˆ¶</button>
                                    </div>
                                    
                                    <p class="goal-tip">æç¤º: æ ¹æ®ç›®æ ‡ç»“æ„ä¿®æ”¹å‘½ä»¤å‚æ•°</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </table>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% endfor %}
    </table>
</div>

<!-- è®¾å¤‡éƒ¨åˆ† -->
<div class="card" id="devices-section">
    <h2>Device Types</h2>
    <table class="responsive-table">
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>File Path</th>
            <th></th>
        </tr>
        {% for device in devices %}
        <tr class="collapsible-row" data-target="device-info-{{ loop.index }}">
            <td>{{ device.id }}</td>
            <td>{{ device.name }}</td>
            <td class="file-path">
                {{ device.file_path }}
                <span class="folder-link" onclick="openFolder('{{ device.file_path }}'); event.stopPropagation();" title="æ‰“å¼€æ–‡ä»¶å¤¹">ğŸ“</span>
            </td>
            <td><span class="toggle-indicator">â–¼</span></td>
        </tr>
        <tr id="device-info-{{ loop.index }}" class="detail-row" style="display: none;">
            <td colspan="5">
                <div class="content-full">
                    <pre>{{ device.class_json }}</pre>
                    
                    {% if device.is_online %}
                    <div class="status-badge"><span class="online-status">åœ¨çº¿</span></div>
                    {% endif %}
                    
                    {% if device.is_online and device.status_publishers %}
                    <h4>çŠ¶æ€å‘å¸ƒè€…:</h4>
                    <ul class="detail-list">
                        {% for status_name, status_info in device.status_publishers.items() %}
                        <li>
                            <strong>{{ status_name }}</strong> - ç±»å‹: {{ status_info.type }}
                            <br>è¯é¢˜: {{ status_info.topic }}
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                    
                    {% if device.is_online and device.actions %}
                    <h4>å¯ç”¨åŠ¨ä½œ:</h4>
                    <ul class="detail-list">
                        {% for action_name, action_info in device.actions.items() %}
                        <li>
                            <strong>{{ action_name }}</strong> - ç±»å‹: {{ action_info.type }}
                            <br>è¯é¢˜: {{ action_info.topic }}
                            <br>
                            <div class="cmd-block">
                                <strong>å‘é€å‘½ä»¤:</strong>
                                <div class="cmd-line">
                                    <pre>{{ action_info.command }}</pre>
                                    <button class="copy-btn" onclick="copyToClipboard(this.previousElementSibling.textContent, event)">å¤åˆ¶</button>
                                    <button class="debug-btn" onclick="toggleDebugInfo(this, event)">è°ƒè¯•</button>
                                    <div class="debug-info" style="display:none;">
                                        <pre>{{ action_info|tojson(indent=2) }}</pre>
                                    </div>
                                </div>
                                
                                <p class="goal-tip">æç¤º: æ ¹æ®ç›®æ ‡ç»“æ„ä¿®æ”¹å‘½ä»¤å‚æ•°</p>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% endfor %}
    </table>
</div>

<!-- èµ„æºéƒ¨åˆ† -->
<div class="card" id="resources-section">
    <h2>Resource Types</h2>
    <table class="responsive-table">
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>File Path</th>
        </tr>
        {% for resource in resources %}
        <tr>
            <td>{{ resource.id }}</td>
            <td>{{ resource.name }}</td>
            <td class="file-path">
                {{ resource.file_path }}
                <span class="folder-link" onclick="openFolder('{{ resource.file_path }}')" title="æ‰“å¼€æ–‡ä»¶å¤¹">ğŸ“</span>
            </td>
        </tr>
        {% endfor %}
    </table>
</div>

<!-- æ¨¡å—éƒ¨åˆ† -->
<div class="card" id="modules-section">
    <h2>Converter Modules</h2>
    <h3>Loaded Modules</h3>
    <table class="responsive-table">
        <tr>
            <th>Module Path</th>
        </tr>
        {% for module in modules.names %}
        <tr>
            <td>{{ module }}</td>
        </tr>
        {% endfor %}
    </table>

    <h3>Available Classes 
        <span class="classes-count">({{ modules.total_count }})</span>
    </h3>
    <table class="responsive-table">
        <tr>
            <th>Class Name</th>
        </tr>
        {% for class_name in modules.classes %}
        <tr>
            <td>{{ class_name }}</td>
        </tr>
        {% endfor %}
    </table>
</div>

<!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
<button id="back-to-top" title="è¿”å›é¡¶éƒ¨">â†‘</button>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // åœ¨é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œåˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initFolderOpener();
        initCollapsibleRows();
        initScrollToSections();
        initBackToTop();
        initWebSocket();
    });

    // WebSocketè¿æ¥
    let ws = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    const reconnectDelay = 3000; // 3ç§’
    let connectionStatusElement = null;
    
    function showConnectionStatus(status, message) {
        // å¦‚æœçŠ¶æ€å…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
        if (!connectionStatusElement) {
            connectionStatusElement = document.createElement('div');
            connectionStatusElement.className = 'connection-status';
            document.body.appendChild(connectionStatusElement);
        }
        
        connectionStatusElement.className = 'connection-status ' + status;
        connectionStatusElement.innerHTML = `<span class="status-dot"></span><span class="status-text">${message}</span>`;
        
        // 3ç§’åè‡ªåŠ¨éšè—
        if (status === 'connected') {
            setTimeout(() => {
                connectionStatusElement.style.opacity = '0';
            }, 3000);
        } else {
            connectionStatusElement.style.opacity = '1';
        }
    }

    function initWebSocket() {
        // è·å–WebSocket URL
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/api/v1/ws/device_status`;
        
        showConnectionStatus('connecting', 'æ­£åœ¨è¿æ¥æœåŠ¡å™¨...');
        
        ws = new WebSocket(wsUrl);
        
        ws.onopen = function() {
            console.log('WebSocketè¿æ¥å·²å»ºç«‹');
            showConnectionStatus('connected', 'å·²è¿æ¥åˆ°æœåŠ¡å™¨');
            reconnectAttempts = 0;
        };
        
        ws.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'device_status') {
                    updateDeviceStatus(data.data);
                }
            } catch (error) {
                console.error('å¤„ç†WebSocketæ¶ˆæ¯æ—¶å‡ºé”™:', error);
            }
        };
        
        ws.onclose = function(event) {
            console.log(`WebSocketè¿æ¥å·²å…³é—­ï¼Œä»£ç : ${event.code}, åŸå› : ${event.reason}`);
            
            if (event.wasClean) {
                showConnectionStatus('disconnected', 'è¿æ¥å·²æ­£å¸¸å…³é—­');
            } else {
                showConnectionStatus('error', 'è¿æ¥æ„å¤–æ–­å¼€');
            }
            
            if (reconnectAttempts < maxReconnectAttempts) {
                showConnectionStatus('reconnecting', `æ­£åœ¨å°è¯•é‡æ–°è¿æ¥ (${reconnectAttempts + 1}/${maxReconnectAttempts})...`);
                setTimeout(initWebSocket, reconnectDelay);
                reconnectAttempts++;
            } else {
                showConnectionStatus('error', 'é‡è¿å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        };
        
        ws.onerror = function(error) {
            console.error('WebSocketé”™è¯¯:', error);
            showConnectionStatus('error', 'WebSocketè¿æ¥é”™è¯¯');
        };
    }

    function updateDeviceStatus(data) {
        const { device_status, device_status_timestamps } = data;
        
        // æŸ¥æ‰¾è®¾å¤‡çŠ¶æ€è¡¨æ ¼ - åœ¨host-node-sectionä¸‹ï¼Œå¯»æ‰¾å…·æœ‰"è®¾å¤‡çŠ¶æ€"æ ‡é¢˜çš„host-section
        const deviceStatusSections = Array.from(document.querySelectorAll('#host-node-section .host-section h3'))
            .filter(h3 => h3.textContent.trim() === 'è®¾å¤‡çŠ¶æ€')
            .map(h3 => h3.parentElement);
            
        if (deviceStatusSections.length === 0) {
            console.log('æœªæ‰¾åˆ°è®¾å¤‡çŠ¶æ€éƒ¨åˆ†');
            return;
        }
        
        const statusSection = deviceStatusSections[0];
        const table = statusSection.querySelector('table.responsive-table');
        
        if (!table) {
            console.log('æœªæ‰¾åˆ°è®¾å¤‡çŠ¶æ€è¡¨æ ¼');
            return;
        }
        
        // ä¿å­˜è¡¨å¤´
        const header = table.rows[0].cloneNode(true);
        
        // æ¸…ç©ºè¡¨æ ¼ï¼ˆä¿ç•™è¡¨å¤´ï¼‰
        while (table.rows.length > 1) {
            table.deleteRow(1);
        }
        
        // æ²¡æœ‰æ•°æ®æ—¶æ˜¾ç¤ºç©ºçŠ¶æ€è¡Œ
        if (Object.keys(device_status).length === 0) {
            const emptyRow = table.insertRow();
            const emptyCell = emptyRow.insertCell();
            emptyCell.colSpan = 4;
            emptyCell.className = 'empty-state';
            emptyCell.textContent = 'æ²¡æœ‰è®¾å¤‡çŠ¶æ€æ•°æ®';
            return;
        }
        
        // æ·»åŠ æ•°æ®è¡Œ
        for (const [device_id, properties] of Object.entries(device_status)) {
            const propNames = Object.keys(properties);
            
            for (let i = 0; i < propNames.length; i++) {
                const prop_name = propNames[i];
                const prop_value = properties[prop_name];
                
                const row = table.insertRow();
                
                // å¦‚æœæ˜¯è®¾å¤‡çš„ç¬¬ä¸€ä¸ªå±æ€§ï¼Œæ·»åŠ è®¾å¤‡IDå•å…ƒæ ¼
                if (i === 0) {
                    const deviceCell = row.insertCell();
                    deviceCell.rowSpan = propNames.length;
                    deviceCell.textContent = device_id;
                }
                
                // æ·»åŠ å±æ€§åç§°å•å…ƒæ ¼
                const propCell = row.insertCell();
                propCell.textContent = prop_name;
                
                // æ·»åŠ å±æ€§å€¼å•å…ƒæ ¼
                const valueCell = row.insertCell();
                valueCell.textContent = prop_value;
                
                // æ·»åŠ æ—¶é—´æˆ³å•å…ƒæ ¼
                const timestampCell = row.insertCell();
                const tsInfo = device_status_timestamps[device_id]?.[prop_name];
                
                if (tsInfo && tsInfo.elapsed >= 0) {
                    const timestampSpan = document.createElement('span');
                    timestampSpan.className = 'timestamp';
                    timestampSpan.setAttribute('title', tsInfo.timestamp);
                    timestampSpan.textContent = `${Math.round(tsInfo.elapsed)} ç§’å‰`;
                    timestampCell.appendChild(timestampSpan);
                } else {
                    const notUpdatedSpan = document.createElement('span');
                    notUpdatedSpan.className = 'timestamp not-updated';
                    notUpdatedSpan.textContent = 'æœªæ›´æ–°';
                    timestampCell.appendChild(notUpdatedSpan);
                }
            }
        }
    }

    // æ–‡ä»¶å¤¹æ‰“å¼€åŠŸèƒ½
    function initFolderOpener() {
        function openFolder(path) {
            if (!path) {
                alert("è·¯å¾„ä¸ºç©º");
                return;
            }
            
            // å¯¹äºWindowsè·¯å¾„ï¼Œç¡®ä¿æ ¼å¼æ­£ç¡®
            const formattedPath = path.includes(':\\') ? path : path.replace(':', ':\\');
            
            fetch(`/open-folder?path=${encodeURIComponent(formattedPath)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') {
                        alert('é”™è¯¯: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('è¯·æ±‚å¤±è´¥: ' + error);
                });
        }
        
        // ç¡®ä¿openFolderå‡½æ•°åœ¨å…¨å±€èŒƒå›´å†…å¯ç”¨
        window.openFolder = openFolder;
    }
    
    // æŠ˜å è¡ŒåŠŸèƒ½
    function initCollapsibleRows() {
        // è®¾å¤‡è¡Œç‚¹å‡»äº‹ä»¶
        const deviceRows = document.querySelectorAll('.collapsible-row');
        deviceRows.forEach(row => {
            row.addEventListener("click", function() {
                const targetId = this.getAttribute('data-target');
                if (!targetId) return;
                
                const content = document.getElementById(targetId);
                if (!content) return;
                
                this.classList.toggle("active");
                
                if (content.style.display === "table-row") {
                    content.style.display = "none";
                    const indicator = this.querySelector('.toggle-indicator');
                    if (indicator) indicator.textContent = "â–¼";
                } else {
                    content.style.display = "table-row";
                    const indicator = this.querySelector('.toggle-indicator');
                    if (indicator) indicator.textContent = "â–²";
                }
            });
        });
        
        // å­è¡Œç‚¹å‡»äº‹ä»¶ï¼ˆçŠ¶æ€å’ŒåŠ¨ä½œè¡Œï¼‰
        const subRows = document.querySelectorAll('.collapsible-sub-row');
        subRows.forEach(row => {
            row.addEventListener("click", function(e) {
                const targetId = this.getAttribute('data-target');
                if (!targetId) return;
                
                const content = document.getElementById(targetId);
                if (!content) return;
                
                if (content.style.display === "table-row" || content.style.display === "") {
                    content.style.display = "none";
                    const indicator = this.querySelector('.toggle-sub-indicator');
                    if (indicator) indicator.textContent = "â–¼";
                } else {
                    content.style.display = "table-row";
                    const indicator = this.querySelector('.toggle-sub-indicator');
                    if (indicator) indicator.textContent = "â–²";
                }
                
                // é˜»æ­¢äº‹ä»¶å†’æ³¡
                e.stopPropagation();
            });
        });
    }
    
    // åˆå§‹åŒ–å¯¼èˆªæ ‡ç­¾è·³è½¬
    function initScrollToSections() {
        const navTabs = document.querySelectorAll('.nav-tab');
        navTabs.forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                if (targetId && targetId.startsWith('#')) {
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({
                            behavior: 'smooth'
                        });
                    }
                }
            });
        });
    }
    
    // åˆå§‹åŒ–è¿”å›é¡¶éƒ¨æŒ‰é’®
    function initBackToTop() {
        const backToTopBtn = document.getElementById("back-to-top");
        if (!backToTopBtn) return;
        
        // æ˜¾ç¤º/éšè—æŒ‰é’®
        window.addEventListener('scroll', function() {
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                backToTopBtn.style.display = "block";
            } else {
                backToTopBtn.style.display = "none";
            }
        });
        
        // ç‚¹å‡»è¿”å›é¡¶éƒ¨
        backToTopBtn.addEventListener('click', function() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    }
    
    // å¤åˆ¶åŠŸèƒ½
    function copyToClipboard(text, event) {
        if (event) event.stopPropagation();
        const textToCopy = text.trim();
        
        // ä½¿ç”¨ç°ä»£APIå¤åˆ¶
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                    showCopySuccess(event.target);
                })
                .catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥: ', err);
                    fallbackCopy(textToCopy, event.target);
                });
        } else {
            fallbackCopy(textToCopy, event.target);
        }
    }
    
    // å¤åˆ¶åŠŸèƒ½çš„åå¤‡æ–¹æ¡ˆ
    function fallbackCopy(text, button) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showCopySuccess(button);
            } else {
                alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶");
            }
        } catch (err) {
            console.error('å¤åˆ¶å¤±è´¥: ', err);
            alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶");
        }
        
        document.body.removeChild(textarea);
    }
    
    // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸ
    function showCopySuccess(button) {
        const originalText = button.textContent;
        button.textContent = "å·²å¤åˆ¶!";
        button.classList.add("copy-success");
        
        setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove("copy-success");
        }, 1500);
    }
    
    // è°ƒè¯•ä¿¡æ¯åˆ‡æ¢
    function toggleDebugInfo(btn, event) {
        event.stopPropagation();
        const debugInfo = btn.nextElementSibling;
        if (debugInfo.style.display === "none" || debugInfo.style.display === "") {
            debugInfo.style.display = "block";
            btn.textContent = "éšè—è°ƒè¯•";
        } else {
            debugInfo.style.display = "none";
            btn.textContent = "è°ƒè¯•";
        }
    }
</script>
<style>
    /* åŸºç¡€æ ·å¼æ”¹è¿› */
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    
    .card {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-radius: 8px;
        margin-bottom: 30px;
        padding: 20px;
        background-color: #fff;
        transition: all 0.3s ease;
        scroll-margin-top: 20px; /* ä¸ºé”šç‚¹æ·»åŠ æ»šåŠ¨è¾¹è· */
    }
    
    .card h2 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
    }
    
    /* å¯¼èˆªæ ‡ç­¾ç¾åŒ– */
    .nav-tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 5px;
        flex-wrap: wrap;
    }
    
    .nav-tab {
        padding: 8px 16px;
        margin-right: 5px;
        background-color: #f5f5f5;
        border-radius: 5px 5px 0 0;
        text-decoration: none;
        color: #555;
        transition: all 0.2s ease;
        font-weight: 500;
    }
    
    .nav-tab:hover {
        background-color: #e0e0e0;
        color: #333;
    }
    
    /* è¡¨æ ¼æ ·å¼ç¾åŒ– */
    .responsive-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        font-size: 14px;
    }
    
    .responsive-table th {
        background-color: #f5f5f5;
        color: #333;
        font-weight: 600;
        text-align: left;
        padding: 12px 15px;
        border-bottom: 2px solid #ddd;
    }
    
    .responsive-table td {
        padding: 10px 15px;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
    }
    
    /* å¯æŠ˜å è¡Œç¾åŒ– */
    .collapsible-row {
        transition: background-color 0.2s ease;
        cursor: pointer;
    }
    
    .collapsible-row:hover {
        background-color: #f9f9f9;
    }
    
    .collapsible-row.active {
        background-color: #f0f7ff;
        border-left: 3px solid #4285f4;
    }
    
    .toggle-indicator, .toggle-sub-indicator {
        font-size: 12px;
        color: #888;
        float: right;
        transition: transform 0.2s ease;
    }
    
    .collapsible-row.active .toggle-indicator {
        transform: rotate(180deg);
        color: #4285f4;
    }
    
    /* è¯¦æƒ…è¡Œæ ·å¼ */
    .detail-row td {
        padding: 0;
    }
    
    .content-full {
        padding: 15px;
        background-color: #fafafa;
        border-top: 1px solid #eee;
    }
    
    /* å­è¡¨æ ¼ï¼ˆå†…éƒ¨è¡¨æ ¼ï¼‰æ ·å¼ */
    .inner-table {
        width: 100%;
        border-collapse: collapse;
        margin: 10px 0;
        font-size: 13px;
    }
    
    .inner-table th {
        background-color: #eef2f7;
        padding: 8px 10px;
        font-weight: 500;
    }
    
    .inner-table td {
        padding: 8px 10px;
        border-bottom: 1px solid #eee;
    }
    
    /* çŠ¶æ€å’ŒåŠ¨ä½œè¡Œæ ·å¼ */
    .topic-row, .action-row {
        background-color: #f9f9f9;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    
    .topic-row:hover, .action-row:hover {
        background-color: #f0f0f0;
    }
    
    /* å¤åˆ¶æŒ‰é’®ç¾åŒ– */
    .toggle-cmd-btn {
        background: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 4px 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .toggle-cmd-btn:hover {
        background: #e0e0e0;
    }
    
    .copy-btn {
        background: #eef;
        border: 1px solid #ccf;
        border-radius: 4px;
        padding: 4px 10px;
        cursor: pointer;
        margin-left: 10px;
        transition: all 0.2s ease;
    }
    
    .copy-btn:hover {
        background: #ddf;
    }
    
    .copy-success {
        background: #dffddf !important;
        color: #2c7c2c !important;
    }
    
    .debug-btn {
        background: #fee;
        border: 1px solid #fcc;
        border-radius: 4px;
        padding: 4px 10px;
        cursor: pointer;
        margin-left: 5px;
        font-size: 12px;
        transition: all 0.2s ease;
    }
    
    .debug-btn:hover {
        background: #fdd;
    }
    
    /* å‘½ä»¤å—æ ·å¼ä¼˜åŒ– */
    .cmd-block {
        background: #f8f8f8;
        border: 1px solid #eee;
        border-radius: 4px;
        padding: 12px;
        margin: 8px 0;
    }
    
    .cmd-line {
        display: flex;
        align-items: center;
        margin: 8px 0;
        background: #fff;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow-x: auto;
        font-family: 'Consolas', 'Monaco', monospace;
    }
    
    .cmd-line pre {
        margin: 0;
        white-space: pre-wrap;
        word-break: break-all;
        flex: 1;
    }
    
    /* è·¯å¾„å’Œæ–‡ä»¶å¤¹é“¾æ¥æ ·å¼ */
    .folder-link {
        cursor: pointer;
        margin-left: 5px;
        color: #4285f4;
        transition: transform 0.2s ease;
    }
    
    .folder-link:hover {
        transform: scale(1.1);
    }
    
    .path-list {
        list-style-type: none;
        padding-left: 10px;
    }
    
    .path-list li {
        margin-bottom: 5px;
    }
    
    /* è¿”å›é¡¶éƒ¨æŒ‰é’® */
    #back-to-top {
        display: none;
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 99;
        font-size: 18px;
        border: none;
        outline: none;
        background-color: #4285f4;
        color: white;
        cursor: pointer;
        padding: 10px 15px;
        border-radius: 50%;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }
    
    #back-to-top:hover {
        background-color: #3367d6;
        transform: translateY(-2px);
    }
    
    /* åœ¨çº¿çŠ¶æ€æ ‡ç­¾ */
    .online-status {
        display: inline-block;
        background-color: #4caf50;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }
    
    /* è¯¦æƒ…åˆ—è¡¨æ ·å¼ */
    .detail-list {
        padding-left: 15px;
    }
    
    .detail-list li {
        margin-bottom: 15px;
        padding-bottom: 12px;
        border-bottom: 1px dashed #eee;
    }
    
    /* æç¤ºæ–‡æœ¬æ ·å¼ */
    .goal-tip {
        font-size: 12px;
        color: #666;
        margin-top: 8px;
        font-style: italic;
        background: #fffde7;
        padding: 5px 8px;
        border-radius: 3px;
        border-left: 3px solid #ffd54f;
    }
    
    /* è°ƒè¯•ä¿¡æ¯æ ·å¼ */
    .debug-info {
        margin-top: 8px;
        background: #fffde7;
        border: 1px solid #fff9c4;
        border-radius: 4px;
        padding: 10px;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
    }
    
    /* æ—¶é—´æˆ³æ ·å¼ */
    .timestamp {
        font-size: 13px;
        background-color: #f5f5f5;
        padding: 3px 6px;
        border-radius: 3px;
        color: #555;
        transition: background-color 0.3s ease;
    }
    
    .timestamp.not-updated {
        background-color: #fff3e0;
        color: #e65100;
    }
    
    .timestamp[title]:hover::after {
        content: 'æ—¶é—´æˆ³: ' attr(title);
        position: absolute;
        background: #333;
        color: #fff;
        padding: 5px 10px;
        border-radius: 4px;
        z-index: 10;
        font-size: 12px;
        margin-top: 5px;
        margin-left: -10px;
    }
    
    /* å“åº”å¼æ ·å¼ä¼˜åŒ– */
    @media screen and (max-width: 768px) {
        .responsive-table {
            width: 100%;
            overflow-x: auto;
            display: block;
        }
        
        .nav-tabs {
            overflow-x: auto;
            white-space: nowrap;
            display: block;
            padding-bottom: 10px;
        }
        
        .nav-tab {
            display: inline-block;
            margin-bottom: 5px;
        }
        
        .file-path {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .cmd-block {
            padding: 10px;
            overflow-x: auto;
        }
        
        .cmd-block pre {
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 12px;
        }
        
        .device-row td:nth-child(3) {
            display: none;
        }
    }
    
    /* åŠ¨ç”»æ•ˆæœ */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .detail-row {
        animation: fadeIn 0.3s ease;
    }
    
    /* è¿æ¥çŠ¶æ€æ ·å¼ */
    .connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 15px;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        background-color: #f5f5f5;
        z-index: 1000;
        display: flex;
        align-items: center;
        font-size: 14px;
        transition: opacity 0.3s ease;
    }
    
    .connection-status .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .connection-status.connecting .status-dot {
        background-color: #ffc107;
        animation: pulse 1.5s infinite;
    }
    
    .connection-status.connected .status-dot {
        background-color: #4caf50;
    }
    
    .connection-status.disconnected .status-dot {
        background-color: #9e9e9e;
    }
    
    .connection-status.reconnecting .status-dot {
        background-color: #ff9800;
        animation: pulse 1.5s infinite;
    }
    
    .connection-status.error .status-dot {
        background-color: #f44336;
    }
    
    @keyframes pulse {
        0% { opacity: 0.5; }
        50% { opacity: 1; }
        100% { opacity: 0.5; }
    }
</style>
{% endblock %} 